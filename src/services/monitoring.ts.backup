/**
 * Error Monitoring & Performance Tracking Service
 * 
 * Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆÙ‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Sentry
 * 
 * @module monitoring
 * @note Sentry Ù…Ø¹Ø·Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹ - ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Console Logging
 */

// ================================================
// Configuration
// ================================================

const ENVIRONMENT = import.meta.env.VITE_ENVIRONMENT || 'development';
const APP_VERSION = import.meta.env.VITE_APP_VERSION || '1.0.0';

export const MONITORING_CONFIG = {
  environment: ENVIRONMENT,
  release: `udent@${APP_VERSION}`,
} as const;

// ================================================
// Initialization
// ================================================

export const initializeMonitoring = (): void => {
  console.log('â„¹ï¸ Monitoring System - Console Mode');
  console.log(`ğŸ“Š Environment: ${ENVIRONMENT}`);
  console.log(`ğŸ”¢ Version: ${APP_VERSION}`);
};

// ================================================
// Error Tracking - Stub Functions
// ================================================

interface ErrorContext {
  tags?: Record<string, string>;
  extra?: Record<string, any>;
  level?: string;
  user?: any;
}

export const captureError = (
  error: Error,
  context?: ErrorContext
): string => {
  console.error('âŒ Error captured:', error);
  if (context) console.error('Context:', context);
  return 'console-' + Date.now();
};

export const captureMessage = (
  message: string,
  level: string = 'info',
  context?: ErrorContext
): string => {
  const emoji = level === 'error' ? 'âŒ' : level === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
  console.log(`${emoji} ${message}`);
  if (context) console.log('Context:', context);
  return 'console-' + Date.now();
};

export const setUser = (user: any): void => {
  console.log('ğŸ‘¤ User set:', user);
};

export const clearUser = (): void => {
  console.log('ğŸ‘¤ User cleared');
};

export const setTags = (tags: Record<string, string>): void => {
  console.log('ğŸ·ï¸ Tags:', tags);
};

export const setExtras = (extras: Record<string, any>): void => {
  console.log('â• Extras:', extras);
};

export const setContext = (name: string, context: Record<string, any> | null): void => {
  console.log(`ğŸ“‹ Context [${name}]:`, context);
};

interface Breadcrumb {
  message: string;
  category?: string;
  level?: string;
  data?: Record<string, any>;
}

export const addBreadcrumb = (breadcrumb: Breadcrumb): void => {
  console.log('ğŸ Breadcrumb:', breadcrumb);
};

// ================================================
// Performance Monitoring - Stub Functions
// ================================================

export const startTransaction = (name: string, op: string): any => {
  const start = performance.now();
  console.log(`â±ï¸ Transaction started: ${name} [${op}]`);
  
  return {
    finish: () => {
      const duration = performance.now() - start;
      console.log(`âœ… Transaction finished: ${name} (${duration.toFixed(2)}ms)`);
    },
    setStatus: (status: string) => {
      console.log(`ğŸ“Š Transaction status: ${status}`);
    },
    setData: (key: string, value: any) => {
      console.log(`ï¿½ Transaction data: ${key} =`, value);
    },
  };
};

export const measurePerformance = async <T>(
  name: string,
  fn: () => T | Promise<T>,
  tags?: Record<string, string>
): Promise<T> => {
  const start = performance.now();
  console.log(`â±ï¸ Measuring: ${name}`, tags);
  
  try {
    const result = await fn();
    const duration = performance.now() - start;
    console.log(`âœ… ${name}: ${duration.toFixed(2)}ms`);
    return result;
  } catch (error) {
    const duration = performance.now() - start;
    console.error(`âŒ ${name} failed after ${duration.toFixed(2)}ms:`, error);
    throw error;
  }
};

// ================================================
// Global Error Handler
// ================================================

export const setupGlobalErrorHandling = (): void => {
  window.addEventListener('error', (event) => {
    console.error('ğŸ”´ Global Error:', event.error);
  });

  window.addEventListener('unhandledrejection', (event) => {
    console.error('ğŸ”´ Unhandled Promise Rejection:', event.reason);
  });

  console.log('âœ… Global error handlers set up');
};

// ================================================
// User Feedback - Stub Function
// ================================================

export const showReportDialog = (options?: any): void => {
  console.log('ğŸ“ Report dialog:', options);
  alert('Error reporting is currently disabled. Please contact support.');
};

// ================================================
// Monitoring Information
// ================================================

export const getMonitoringInfo = () => ({
  enabled: false,
  environment: ENVIRONMENT,
  version: APP_VERSION,
  mode: 'console-only',
  sessionId: 'local-' + Date.now(),
  user: null,
});

// ================================================
// Exports
// ================================================

export default {
  initializeMonitoring,
  captureError,
  captureMessage,
  setUser,
  clearUser,
  setTags,
  setExtras,
  setContext,
  addBreadcrumb,
  startTransaction,
  measurePerformance,
  setupGlobalErrorHandling,
  showReportDialog,
  getMonitoringInfo,
};
};

// ================================================
// Error Tracking
// ================================================

/**
 * ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø£ ÙÙŠ Sentry
 */
export const captureError = (
  error: Error,
  context?: {
    level?: Sentry.SeverityLevel;
    tags?: Record<string, string>;
    extra?: Record<string, unknown>;
    user?: Sentry.User;
  }
): string => {
  if (!SENTRY_DSN) {
    console.error('Error:', error);
    return '';
  }

  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ù‚
  if (context) {
    if (context.tags) {
      Sentry.setTags(context.tags);
    }
    
    if (context.extra) {
      Sentry.setExtras(context.extra);
    }
    
    if (context.user) {
      Sentry.setUser(context.user);
    }
  }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
  const eventId = Sentry.captureException(error, {
    level: context?.level || 'error',
  });

  return eventId;
};

/**
 * ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Sentry
 */
export const captureMessage = (
  message: string,
  level: Sentry.SeverityLevel = 'info',
  context?: {
    tags?: Record<string, string>;
    extra?: Record<string, unknown>;
  }
): string => {
  if (!SENTRY_DSN) {
    console.log(`[${level}] ${message}`);
    return '';
  }

  if (context) {
    if (context.tags) {
      Sentry.setTags(context.tags);
    }
    
    if (context.extra) {
      Sentry.setExtras(context.extra);
    }
  }

  return Sentry.captureMessage(message, level);
};

// ================================================
// User Context
// ================================================

/**
 * ØªØ¹ÙŠÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
 */
export const setUser = (user: {
  id?: string;
  email?: string;
  username?: string;
  clinicId?: string;
  role?: string;
}): void => {
  if (!SENTRY_DSN) return;

  Sentry.setUser({
    id: user.id,
    email: user.email,
    username: user.username,
    clinic_id: user.clinicId,
    role: user.role,
  });
};

/**
 * Ù…Ø³Ø­ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬)
 */
export const clearUser = (): void => {
  if (!SENTRY_DSN) return;
  Sentry.setUser(null);
};

// ================================================
// Tags & Context
// ================================================

/**
 * Ø¥Ø¶Ø§ÙØ© tags Ù„Ù„Ø³ÙŠØ§Ù‚
 */
export const setTags = (tags: Record<string, string>): void => {
  if (!SENTRY_DSN) return;
  Sentry.setTags(tags);
};

/**
 * Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø³ÙŠØ§Ù‚
 */
export const setExtras = (extras: Record<string, unknown>): void => {
  if (!SENTRY_DSN) return;
  Sentry.setExtras(extras);
};

/**
 * ØªØ¹ÙŠÙŠÙ† Ø³ÙŠØ§Ù‚ Ù…Ø­Ø¯Ø¯
 */
export const setContext = (name: string, context: Record<string, unknown>): void => {
  if (!SENTRY_DSN) return;
  Sentry.setContext(name, context);
};

// ================================================
// Breadcrumbs
// ================================================

/**
 * Ø¥Ø¶Ø§ÙØ© breadcrumb (Ø£Ø«Ø±) Ù„Ù„ØªØªØ¨Ø¹
 */
export const addBreadcrumb = (breadcrumb: {
  message: string;
  category?: string;
  level?: Sentry.SeverityLevel;
  data?: Record<string, unknown>;
}): void => {
  if (!SENTRY_DSN) return;

  Sentry.addBreadcrumb({
    message: breadcrumb.message,
    category: breadcrumb.category || 'custom',
    level: breadcrumb.level || 'info',
    data: breadcrumb.data,
    timestamp: Date.now() / 1000,
  });
};

// ================================================
// Performance Tracking
// ================================================

/**
 * Ø¨Ø¯Ø¡ transaction Ù„Ù„Ø£Ø¯Ø§Ø¡
 */
export const startTransaction = (
  name: string,
  op: string = 'custom'
): Sentry.Transaction | undefined => {
  if (!SENTRY_DSN) return undefined;

  return Sentry.startTransaction({
    name,
    op,
  });
};

/**
 * Ù‚ÙŠØ§Ø³ ÙˆÙ‚Øª ØªÙ†ÙÙŠØ° Ø¯Ø§Ù„Ø©
 */
export const measurePerformance = async <T,>(
  name: string,
  fn: () => Promise<T>
): Promise<T> => {
  if (!SENTRY_DSN) {
    return await fn();
  }

  const transaction = startTransaction(name);
  
  try {
    const result = await fn();
    transaction?.setStatus('ok');
    return result;
  } catch (error) {
    transaction?.setStatus('internal_error');
    throw error;
  } finally {
    transaction?.finish();
  }
};

// ================================================
// Network Monitoring
// ================================================

/**
 * ØªØªØ¨Ø¹ API calls
 */
export const trackApiCall = (
  url: string,
  method: string,
  statusCode: number,
  duration: number,
  error?: Error
): void => {
  addBreadcrumb({
    message: `API ${method} ${url}`,
    category: 'api',
    level: statusCode >= 400 ? 'error' : 'info',
    data: {
      url,
      method,
      statusCode,
      duration,
      error: error?.message,
    },
  });

  if (error) {
    captureError(error, {
      level: 'error',
      tags: {
        api_url: url,
        api_method: method,
        status_code: statusCode.toString(),
      },
      extra: {
        duration,
      },
    });
  }
};

// ================================================
// Custom Monitoring
// ================================================

/**
 * ØªØªØ¨Ø¹ Ø¹Ù…Ù„ÙŠØ© Ù…Ø®ØµØµØ©
 */
export const trackOperation = (
  operation: string,
  data?: Record<string, unknown>
): void => {
  addBreadcrumb({
    message: operation,
    category: 'operation',
    data,
  });
};

/**
 * ØªØªØ¨Ø¹ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
 */
export const trackUserAction = (
  action: string,
  category: string,
  data?: Record<string, unknown>
): void => {
  addBreadcrumb({
    message: action,
    category: `user.${category}`,
    data,
  });
};

/**
 * ØªØªØ¨Ø¹ navigation
 */
export const trackNavigation = (from: string, to: string): void => {
  addBreadcrumb({
    message: `Navigation: ${from} â†’ ${to}`,
    category: 'navigation',
    data: { from, to },
  });
};

// ================================================
// Error Reporting UI
// ================================================

/**
 * Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
 */
export const showReportDialog = (eventId: string): void => {
  if (!SENTRY_DSN) return;

  Sentry.showReportDialog({
    eventId,
    title: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹',
    subtitle: 'ÙØ±ÙŠÙ‚Ù†Ø§ ØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ù‡ Ø¨Ø§Ù„Ù…Ø´ÙƒÙ„Ø©',
    subtitle2: 'Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©ØŒ Ø£Ø®Ø¨Ø±Ù†Ø§ Ø¨Ù…Ø§ Ø­Ø¯Ø« Ø£Ø¯Ù†Ø§Ù‡.',
    labelName: 'Ø§Ù„Ø§Ø³Ù…',
    labelEmail: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
    labelComments: 'Ù…Ø§Ø°Ø§ Ø­Ø¯Ø«ØŸ',
    labelClose: 'Ø¥ØºÙ„Ø§Ù‚',
    labelSubmit: 'Ø¥Ø±Ø³Ø§Ù„',
    errorGeneric: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ±Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
    errorFormEntry: 'Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ ØºÙŠØ± ØµØ§Ù„Ø­Ø©. ÙŠØ±Ø¬Ù‰ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
    successMessage: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ. Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ!',
  });
};

// ================================================
// Utilities
// ================================================

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Sentry
 */
export const isMonitoringEnabled = (): boolean => {
  return !!SENTRY_DSN;
};

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
 */
export const getCurrentSession = (): {
  sessionId?: string;
  user?: Sentry.User;
} => {
  if (!SENTRY_DSN) return {};

  return {
    sessionId: Sentry.getCurrentHub().getScope().getSession()?.id,
    user: Sentry.getCurrentHub().getScope().getUser(),
  };
};

// ================================================
// Export All
// ================================================

export default {
  initialize: initializeMonitoring,
  captureError,
  captureMessage,
  setUser,
  clearUser,
  setTags,
  setExtras,
  setContext,
  addBreadcrumb,
  startTransaction,
  measurePerformance,
  trackApiCall,
  trackOperation,
  trackUserAction,
  trackNavigation,
  showReportDialog,
  isMonitoringEnabled,
  getCurrentSession,
};
